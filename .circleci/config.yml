version: 2.1

orbs:
  # slackのコンフィグパッケージをインポート
  slack: circleci/slack@3.2.0

jobs:
  build:
    working_directory: ~/tk-watanabe913
    
    # Dockerコンテナを利用する
    docker:
      # 後続に記載するstepsを実行するメインとなるDockerコンテナを指定する
      - image: circleci/python:3.7.3

    steps:
      # リポジトリのコードを working_directory にチェックアウト
      - checkout

      # テストの実行
      - run:
          name: run tests
          command: |
            python test_sum.py

  deploy:
    machine:
      enabled: true
    working_directory: ~/tk-watanabe913
    environment:
      - AWS_DEFAULT_REGION: ap-northeast-1
      - AWS_S3_BUCKET_NAME_MASTER: nitcirclecitest-master
      - AWS_S3_BUCKET_NAME_DEVELOP: nitcirclecitest-develop

    steps:
      # awscliをインストール
      - run:
          name: Install awscli
          command: sudo pip install awscli

      - run:
          name: Deploy to S3 if branch is Master.
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ]; then
              aws s3 sync ~/tk-watanabe913 s3://${AWS_S3_BUCKET_NAME_MASTER}/ --exact-timestamps --delete
            elif  [ "${CIRCLE_BRANCH}" == "develop" ]; then
              aws s3 sync ~/tk-watanabe913 s3://${AWS_S3_BUCKET_NAME_DEVELOP}/ --exact-timestamps --delete
            fi
  notify-to-slack-for-approval:
    executor:
      name: python3_6_1

    steps:
      - slack/approval:
          message: "本番環境へのデプロイを承認してください"
          mentions: "here"
          color: "#F5E911"

workflows:
  version: 2
  build-and-deploy:
    jobs:
      # buildのジョブを実行
      - build
      
      # 承認ジョブの実行
      # WEBページで承認された時点で後続のジョブを実行する
      - approval-deploy:
          type: approval
          requires:
            - build

      # 承認された後に実行する
      - deploy:
          requires:
            - approval-deploy
          filters:
            branches:
              only: master

      - notify-to-slack-for-approval:
          requires:
            - build
